<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BHAROSA Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --border:rgba(15,23,42,.08);
      --shadow:0 20px 60px rgba(2,6,23,.12);
      --brand:#2874f0;
      --brand-dark:#1e5fcd;
      --accent:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --radius-xl:26px;
      --radius:18px;
      --container:1200px;
      --header-h:76px;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 520px at 10% -10%, rgba(40,116,240,.18) 0%, rgba(40,116,240,0) 60%),
        radial-gradient(900px 520px at 90% -10%, rgba(34,197,94,.18) 0%, rgba(34,197,94,0) 55%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    a{text-decoration:none;color:inherit}
    button{font-family:inherit}

    .container{
      max-width:min(var(--container), 94vw);
      margin:0 auto;
      padding:0 18px;
    }

    /* Topbar */
    .topbar{
      position:sticky;
      top:0;
      z-index:90;
      backdrop-filter:saturate(160%) blur(10px);
      background:linear-gradient(180deg, rgba(40,116,240,.95), rgba(30,95,205,.95));
      border-bottom:1px solid rgba(255,255,255,.15);
    }

    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      height:var(--header-h);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.02em;
      color:#fff;
    }
    .brand img{height:36px}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:12px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.16);
      font-weight:800;
      font-size:13px;
      color:#fff;
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .pill:hover{
      transform:translateY(-1px);
      background:rgba(255,255,255,.22);
      box-shadow:0 8px 24px rgba(0,0,0,.15);
    }

    /* Page */
    .wrap{padding:28px 0 72px}

    /* Cards */
    .card{
      background:linear-gradient(180deg, #ffffff, #fbfdff);
      border:1px solid var(--border);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-bottom:20px;
      animation:fadeUp .35s ease both;
    }

    @keyframes fadeUp{
      from{opacity:0; transform:translateY(8px)}
      to{opacity:1; transform:translateY(0)}
    }

    .head{
      padding:18px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:
        linear-gradient(180deg, rgba(246,247,251,1), rgba(255,255,255,1));
    }

    .head strong{
      font-size:14px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#334155;
    }

    .body{padding:20px}

    /* Stats Grid */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:20px;
      margin-bottom:20px;
    }

    .stat-card{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff;
      padding:20px;
      border-radius:16px;
      position:relative;
      overflow:hidden;
    }
    .stat-card::before{
      content:'';
      position:absolute;
      top:-50%;
      right:-50%;
      width:200%;
      height:200%;
      background:radial-gradient(circle, rgba(255,255,255,.1) 0%, transparent 70%);
    }
    .stat-card.green{
      background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
    .stat-card.blue{
      background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .stat-card.orange{
      background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    .stat-card.red{
      background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .stat-value{
      font-size:32px;
      font-weight:900;
      margin-bottom:4px;
    }
    .stat-label{
      font-size:14px;
      opacity:0.9;
    }
    .stat-change{
      font-size:12px;
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:4px;
    }

    /* Charts */
    .chart-container{
      position:relative;
      height:300px;
      margin-bottom:20px;
    }

    /* Date Filter */
    .date-filter{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .date-filter select, .date-filter input{
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:14px;
    }
    .date-filter button{
      padding:8px 16px;
      background:var(--brand);
      color:#fff;
      border:none;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      transition:background .15s ease;
    }
    .date-filter button:hover{
      background:var(--brand-dark);
    }

    /* Tables */
    .table-wrapper{
      overflow-x:auto;
      margin-top:20px;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    th, td{
      padding:12px;
      text-align:left;
      border-bottom:1px solid var(--border);
    }
    th{
      font-weight:700;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--muted);
    }
    td{
      font-size:14px;
    }

    /* Loading */
    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px;
      color:var(--muted);
    }
    .spinner{
      width:20px;
      height:20px;
      border:2px solid var(--border);
      border-top-color:var(--brand);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-right:10px;
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }

    /* Toast */
    .toast{
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--brand);
      color:#fff;
      padding:12px 20px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      z-index:9999;
      animation:slideUp 0.3s ease;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    @keyframes slideUp{
      from{transform:translateY(100%); opacity:0}
      to{transform:translateY(0); opacity:1}
    }

    /* Responsive */
    @media (max-width:768px){
      .stats-grid{
        grid-template-columns:1fr;
      }
      .date-filter{
        flex-direction:column;
        align-items:stretch;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; animation:none !important}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="topbar-inner">
        <a class="brand" href="shop.html">
          <img src="bharosa.png" alt="BHAROSA" />
          <span>Analytics Dashboard</span>
        </a>
        <a class="pill" href="orders.html">Orders</a>
        <a class="pill" href="analytics-export.html">Export</a>
      </div>
    </div>
  </header>

  <main class="container wrap">
    <!-- Date Filter -->
    <div class="card">
      <div class="head">
        <strong>Filter</strong>
        <div class="date-filter">
          <select id="period">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
            <option value="custom">Custom range</option>
          </select>
          <input type="date" id="startDate" style="display:none;">
          <input type="date" id="endDate" style="display:none;">
          <button onclick="refreshAnalytics()">Apply</button>
        </div>
      </div>
    </div>

    <!-- Overview Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="loading"><div class="spinner"></div>Loading stats...</div>
    </div>

    <!-- Sales Chart -->
    <div class="card">
      <div class="head">
        <strong>Sales Overview</strong>
        <select id="salesChartType">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div class="body">
        <div class="chart-container">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Products -->
    <div class="card">
      <div class="head">
        <strong>Top Products</strong>
        <span id="topProductsCount"></span>
      </div>
      <div class="body">
        <div class="chart-container">
          <canvas id="productsChart"></canvas>
        </div>
        <div class="table-wrapper">
          <table id="topProductsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Units Sold</th>
                <th>Revenue</th>
                <th>Growth</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Customer Analytics -->
    <div class="card">
      <div class="head">
        <strong>Customer Analytics</strong>
      </div>
      <div class="body">
        <div class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-value" id="totalCustomers">-</div>
            <div class="stat-label">Total Customers</div>
            <div class="stat-change" id="customersGrowth">-</div>
          </div>
          <div class="stat-card green">
            <div class="stat-value" id="repeatCustomers">-</div>
            <div class="stat-label">Repeat Customers</div>
            <div class="stat-change" id="repeatRate">-</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-value" id="avgOrderValue">-</div>
            <div class="stat-label">Avg Order Value</div>
            <div class="stat-change" id="aovGrowth">-</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="customersChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="card">
      <div class="head">
        <strong>Payment Methods</strong>
      </div>
      <div class="body">
        <div class="chart-container">
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Chart instances
    let salesChart, productsChart, customersChart, paymentChart;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      refreshAnalytics();
      
      // Period change handler
      document.getElementById('period').addEventListener('change', (e) => {
        const customInputs = document.querySelectorAll('#startDate, #endDate');
        if (e.target.value === 'custom') {
          customInputs.forEach(input => input.style.display = 'inline-block');
        } else {
          customInputs.forEach(input => input.style.display = 'none');
        }
      });
    });

    function initCharts() {
      // Sales Chart
      const salesCtx = document.getElementById('salesChart').getContext('2d');
      salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Revenue',
            data: [],
            borderColor: '#2874f0',
            backgroundColor: 'rgba(40, 116, 240, 0.1)',
            tension: 0.4
          }, {
            label: 'Orders',
            data: [],
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });

      // Products Chart
      const productsCtx = document.getElementById('productsChart').getContext('2d');
      productsChart = new Chart(productsCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Units Sold',
            data: [],
            backgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      // Customers Chart
      const customersCtx = document.getElementById('customersChart').getContext('2d');
      customersChart = new Chart(customersCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'New Customers',
            data: [],
            borderColor: '#2874f0',
            backgroundColor: 'rgba(40, 116, 240, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      // Payment Chart
      const paymentCtx = document.getElementById('paymentChart').getContext('2d');
      paymentChart = new Chart(paymentCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: ['#2874f0', '#22c55e', '#f59e0b', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    async function refreshAnalytics() {
      try {
        showToast('Loading analytics...');
        const period = document.getElementById('period').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        const query = new URLSearchParams({ period });
        if (period === 'custom' && startDate && endDate) {
          query.append('startDate', startDate);
          query.append('endDate', endDate);
        }

        const response = await fetch(`/api/analytics?${query}`);
        const data = await response.json();
        
        if (response.ok) {
          updateStats(data.stats);
          updateSalesChart(data.sales);
          updateProductsChart(data.products);
          updateCustomerAnalytics(data.customers);
          updatePaymentChart(data.payments);
          showToast('Analytics updated');
        } else {
          showToast('Failed to load analytics');
        }
      } catch (error) {
        console.error('Analytics error:', error);
        showToast('Error loading analytics');
      }
    }

    function updateStats(stats) {
      const statsGrid = document.getElementById('statsGrid');
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${stats.totalRevenue || '₹0'}</div>
          <div class="stat-label">Total Revenue</div>
          <div class="stat-change">↑ ${stats.revenueGrowth || '0%'} from last period</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value">${stats.totalOrders || 0}</div>
          <div class="stat-label">Total Orders</div>
          <div class="stat-change">↑ ${stats.ordersGrowth || '0%'} from last period</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-value">${stats.avgOrderValue || '₹0'}</div>
          <div class="stat-label">Avg Order Value</div>
          <div class="stat-change">↑ ${stats.aovGrowth || '0%'} from last period</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-value">${stats.conversionRate || '0%'}</div>
          <div class="stat-label">Conversion Rate</div>
          <div class="stat-change">↑ ${stats.conversionGrowth || '0%'} from last period</div>
        </div>
      `;
    }

    function updateSalesChart(sales) {
      salesChart.data.labels = sales.labels;
      salesChart.data.datasets[0].data = sales.revenue;
      salesChart.data.datasets[1].data = sales.orders;
      salesChart.update();
    }

    function updateProductsChart(products) {
      productsChart.data.labels = products.map(p => p.name);
      productsChart.data.datasets[0].data = products.map(p => p.unitsSold);
      productsChart.update();

      // Update table
      const tbody = document.querySelector('#topProductsTable tbody');
      tbody.innerHTML = products.map(product => `
        <tr>
          <td>${product.name}</td>
          <td>${product.unitsSold}</td>
          <td>₹${product.revenue}</td>
          <td style="color: ${product.growth >= 0 ? '#22c55e' : '#ef4444'}">
            ${product.growth >= 0 ? '↑' : '↓'} ${Math.abs(product.growth)}%
          </td>
        </tr>
      `).join('');
      
      document.getElementById('topProductsCount').textContent = `Top ${products.length} products`;
    }

    function updateCustomerAnalytics(customers) {
      document.getElementById('totalCustomers').textContent = customers.total;
      document.getElementById('customersGrowth').textContent = `↑ ${customers.growth}% from last period`;
      document.getElementById('repeatCustomers').textContent = customers.repeat;
      document.getElementById('repeatRate').textContent = `${customers.repeatRate}% repeat rate`;
      document.getElementById('avgOrderValue').textContent = `₹${customers.avgOrderValue}`;
      document.getElementById('aovGrowth').textContent = `↑ ${customers.aovGrowth}% from last period`;

      customersChart.data.labels = customers.newCustomers.labels;
      customersChart.data.datasets[0].data = customers.newCustomers.data;
      customersChart.update();
    }

    function updatePaymentChart(payments) {
      paymentChart.data.labels = payments.map(p => p.method);
      paymentChart.data.datasets[0].data = payments.map(p => p.count);
      paymentChart.update();
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
