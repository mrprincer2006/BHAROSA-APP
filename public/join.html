<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Join BHAROSA</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#2f7d4a;
      --green-dark:#25653c;
      --accent:#ff8a1f;
      --accent-soft:#fff3e8;
      --text:#0f172a;
      --muted:#64748b;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:rgba(15, 23, 42, .08);
      --shadow:0 25px 70px rgba(0,0,0,.12);
      --shadow-lg:0 35px 90px rgba(0,0,0,.15);
      --radius-lg:28px;
      --radius-md:18px;
      --radius-sm:12px;
      --gradient-primary:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-accent:linear-gradient(135deg, #ff8a1f 0%, #ff6b6b 100%);
      --gradient-bg:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html, body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,sans-serif;
      color:var(--text);
      background:var(--gradient-bg);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position:relative;
    }
    
    body::before{
      content:'';
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:
        radial-gradient(800px 400px at 20% 10%, rgba(102, 126, 234, .08) 0%, rgba(102, 126, 234, 0) 60%),
        radial-gradient(600px 300px at 80% 20%, rgba(168, 85, 247, .06) 0%, rgba(168, 85, 247, 0) 60%);
      pointer-events:none;
      z-index:-1;
    }

    a{color:inherit;text-decoration:none}

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:saturate(140%) blur(20px);
      background:rgba(250,250,247,.85);
      border-bottom:1px solid rgba(15, 23, 42, .06);
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.02em;
      font-size:20px;
      color:var(--green);
    }
    .brand img{
      height:40px;
      width:auto;
      display:block;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
    }
    .brand-text{
      font-size:20px;
      font-weight:900;
      letter-spacing:.02em;
      color:var(--green);
      display:none; /* Hidden by default, shown when image fails */
    }
    .brand img{height:36px;width:auto;display:block}
    .back{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 18px;
      border-radius:16px;
      border:1px solid rgba(15, 23, 42, .10);
      background:rgba(255,255,255,.95);
      font-weight:700;
      color:#0f172a;
      transition:all 0.3s ease;
    }
    .back:hover{
      background:rgba(255,255,255,1);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,.1);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:60px 20px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }

    .hero-section{
      text-align:center;
      margin-bottom:40px;
      animation:fadeInUp 0.8s ease both;
    }
    .hero-content{
      max-width:600px;
      margin:0 auto;
    }
    .hero-title{
      font-size:48px;
      font-weight:900;
      color:var(--text);
      margin-bottom:16px;
      background:var(--gradient-primary);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      padding:20px 40px;
      border-radius:var(--radius-lg);
      display:inline-block;
      box-shadow:var(--shadow-lg);
    }
    .hero-subtitle{
      font-size:18px;
      color:var(--muted);
      margin-bottom:24px;
      font-weight:500;
    }
    .hero-benefits{
      display:flex;
      justify-content:center;
      gap:20px;
      flex-wrap:wrap;
    }
    .hero-benefit{
      background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2);
      padding:12px 20px;
      border-radius:var(--radius-md);
      font-weight:600;
      font-size:14px;
      backdrop-filter:blur(10px);
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-lg);
      overflow:hidden;
      animation:fadeInUp 0.8s ease both;
      backdrop-filter:blur(20px);
      margin:0 auto;
    }

    @keyframes fadeUp{
      from{opacity:0; transform:translateY(16px)}
      to{opacity:1; transform:translateY(0)}
    }
    
    @keyframes float{
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(5deg); }
    }
    
    @keyframes fadeInUp{
      from{opacity:0; transform:translateY(30px)}
      to{opacity:1; transform:translateY(0)}
    }

    .card-head{
      padding:30px 30px 20px;
      border-bottom:1px solid rgba(15, 23, 42, .06);
      background:linear-gradient(180deg, #ffffff 0%, rgba(248, 250, 252, 0.8) 100%);
      backdrop-filter:blur(10px);
    }

    .stepper{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:20px;
      background:rgba(15, 23, 42, .04);
      border:1px solid rgba(15, 23, 42, .08);
      color:#0f172a;
      font-weight:800;
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      transition:all 0.3s ease;
    }
    .chip.active{
      background:var(--gradient-primary);
      border-color:rgba(47, 125, 74, .3);
      color:#fff;
      box-shadow:0 4px 12px rgba(47, 125, 74, .3);
    }
    .chip.done{
      background:var(--gradient-accent);
      border-color:rgba(255, 138, 31, .3);
      color:#fff;
      box-shadow:0 4px 12px rgba(255, 138, 31, .3);
    }

    .card-body{padding:22px}

    .title{
      font-size:28px;
      letter-spacing:-.02em;
      margin-top:20px;
      font-weight:800;
      color:var(--text);
      text-shadow:0 2px 4px rgba(0,0,0,.05);
    }
    .subtitle{color:var(--muted);margin-top:6px;font-size:14px}

    .form{
      margin-top:22px;
      display:grid;
      gap:16px;
    }

    label{
      font-size:14px;
      color:#0f172a;
      font-weight:800;
      margin-bottom:6px;
      display:block;
    }

    .field{
      display:grid;
      gap:8px;
    }

    input, textarea, select{
      width:100%;
      padding:18px 16px;
      border-radius:var(--radius-md);
      border:1px solid rgba(15, 23, 42, .12);
      background:rgba(255,255,255,.95);
      font-family:inherit;
      font-size:15px;
      outline:none;
      transition:border .2s ease, box-shadow .2s ease, transform .12s ease;
      backdrop-filter:blur(10px);
    }
    input:hover, textarea:hover, select:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,.1);
    }
    input:focus, textarea:focus, select:focus{
      border-color:rgba(47, 125, 74, .5);
      box-shadow:0 0 0 6px rgba(47, 125, 74, .2);
      background:rgba(255,255,255,1);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .actions{
      margin-top:6px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .actions.split{
      justify-content:space-between;
    }

    .btn-wide{
      min-width:220px;
      padding:14px 18px;
      border-radius:16px;
    }

    .btn{
      border:0;
      cursor:pointer;
      padding:14px 18px;
      border-radius:var(--radius-md);
      font-weight:900;
      font-family:inherit;
      font-size:14px;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn-primary{
      background:var(--gradient-primary);
      color:#fff;
      box-shadow:0 18px 40px rgba(47, 125, 74, .35);
      border:none;
      transition:all 0.3s ease;
    }
    .btn-primary:hover{
      transform:translateY(-2px) scale(1.02);
      box-shadow:0 25px 50px rgba(47, 125, 74, .45);
    }
    .btn-ghost{
      background:rgba(255,255,255,.95);
      color:#0f172a;
      border:1px solid rgba(15, 23, 42, .08);
      backdrop-filter:blur(10px);
      transition:all 0.3s ease;
    }
    .btn-ghost:hover{
      background:rgba(255,255,255,1);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,.1);
    }

    .btn-link{
      background:transparent;
      border:0;
      color:#2563eb;
      font-weight:900;
      padding:12px 10px;
      border-radius:12px;
      cursor:pointer;
    }
    .btn-link:hover{
      background:rgba(37, 99, 235, .1);
      transform:translateY(-1px);
    }

    .loc-btn{
      width:max-content;
      background:var(--gradient-accent);
      color:#fff;
      border-radius:12px;
      padding:12px 16px;
      box-shadow:0 14px 28px rgba(37, 99, 235, .25);
      border:1px solid rgba(255,255,255,.25);
      transition:all 0.3s ease;
    }
    .loc-btn:hover{
      transform:translateY(-2px) scale(1.02);
      box-shadow:0 18px 36px rgba(37, 99, 235, .35);
    }

    .details-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .span-2{grid-column: 1 / -1}

    .address-type{
      display:flex;
      align-items:center;
      gap:18px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .radio{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      border-radius:16px;
      border:1px solid rgba(15, 23, 42, .10);
      background:rgba(15, 23, 42, .02);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      color:#0f172a;
      transition:all 0.3s ease;
    }
    .radio:hover{
      background:rgba(15, 23, 42, .05);
      transform:translateY(-1px);
    }
    .radio input:checked + span{
      background:var(--gradient-primary);
      color:#fff;
    }
    .radio input{width:18px;height:18px}

    .hint{color:var(--muted);font-size:13px}
    .note{
      margin-top:16px;
      padding:16px 18px;
      border-radius:var(--radius-md);
      border:1px solid rgba(255, 138, 31, .25);
      background:var(--accent-soft);
      color:#7a3600;
      font-size:13px;
      animation:fadeUp .4s ease both;
      display:none;
      backdrop-filter:blur(10px);
    }
    .note.show{display:block}

    .otp-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .otp-row input{max-width:220px}

    .hidden{display:none !important}

    .loading {
      opacity: 0.7;
      pointer-events: none;
      position: relative;
    }
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }
    .success {
      border-color: var(--green) !important;
      box-shadow: 0 0 0 3px rgba(47, 125, 74, 0.1) !important;
    }

    .otp-timer {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .terms-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 16px;
      font-size: 14px;
    }
    .terms-checkbox input {
      margin-top: 2px;
      width: 16px;
      height: 16px;
    }
    .terms-checkbox label {
      line-height: 1.4;
      color: var(--text);
    }
    .terms-checkbox a {
      color: var(--accent);
      text-decoration: underline;
    }

    @media (max-width: 980px){
      .wrap{
        padding:40px 16px;
        flex-direction:column;
      }
      .hero-title{
        font-size:36px;
        padding:16px 32px;
      }
      .hero-subtitle{
        font-size:16px;
        margin-bottom:20px;
      }
      .hero-benefits{
        flex-direction:column;
        gap:12px;
      }
      .hero-benefit{
        padding:10px 16px;
        font-size:13px;
      }
    }

    @media (max-width: 768px){
      .wrap{
        padding:30px 12px;
      }
      .hero-section{
        margin-bottom:30px;
      }
      .hero-title{
        font-size:32px;
        padding:14px 28px;
      }
      .hero-subtitle{
        font-size:15px;
        margin-bottom:16px;
      }
      .hero-benefits{
        gap:10px;
      }
      .hero-benefit{
        padding:8px 12px;
        font-size:12px;
      }
      .card{
        margin:0 auto;
        max-width:100%;
      }
      .card-head{
        padding:20px 20px 16px;
      }
      .stepper{
        justify-content:center;
        gap:8px;
      }
      .chip{
        padding:8px 12px;
        font-size:11px;
      }
      .title{
        font-size:20px;
        margin-top:16px;
      }
      .subtitle{
        font-size:13px;
        margin-top:4px;
      }
      .form{
        margin-top:16px;
        gap:12px;
      }
      .field{
        gap:6px;
      }
      input, textarea, select{
        padding:14px 14px;
        font-size:14px;
      }
      .btn{
        padding:12px 16px;
        font-size:13px;
      }
      .actions{
        flex-direction:column;
        gap:8px;
      }
      .btn-wide{
        min-width:100%;
        padding:12px 16px;
      }
    }

    @media (max-width: 480px){
      .wrap{
        padding:20px 8px;
      }
      .hero-title{
        font-size:28px;
        padding:12px 24px;
      }
      .hero-subtitle{
        font-size:14px;
        margin-bottom:16px;
      }
      .hero-benefits{
        gap:8px;
      }
      .hero-benefit{
        padding:6px 12px;
        font-size:12px;
      }
      .card-head{
        padding:16px 16px 12px;
      }
      .stepper{
        gap:6px;
      }
      .chip{
        padding:6px 10px;
        font-size:10px;
      }
      .title{
        font-size:18px;
        margin-top:12px;
      }
      .subtitle{
        font-size:12px;
        margin-top:4px;
      }
      .form{
        margin-top:12px;
        gap:8px;
      }
      .field{
        gap:4px;
      }
      input, textarea, select{
        padding:12px 12px;
        font-size:13px;
      }
      .btn{
        padding:10px 14px;
        font-size:12px;
      }
      .otp-row{
        flex-direction:column;
        gap:8px;
      }
      .otp-row input{
        max-width:100%;
      }
      .details-grid{
        grid-template-columns:1fr;
        gap:8px;
      }
      .address-type{
        flex-direction:column;
        gap:12px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important; transition:none !important; animation:none !important}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="images/bharosa.png" alt="BHAROSA" onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3b3gAAAAAAAAAAAAEUgAAAAA'" />
        <span class="brand-text">BHAROSA</span>
      </div>
      <a class="back" href="index.html" aria-label="Back to home">‚Üê Back</a>
    </div>
  </div>

  <main class="wrap">
    <!-- Hero Section -->
    <div class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">Join BHAROSA</h1>
        <p class="hero-subtitle">Your trusted local delivery platform</p>
        <div class="hero-benefits">
          <div class="hero-benefit">üí∞ ‚Çπ10 lifetime membership</div>
          <div class="hero-benefit">üöö Fast local delivery</div>
          <div class="hero-benefit">‚ú® No hidden fees</div>
        </div>
      </div>
    </div>

    <!-- Form Section -->
    <section class="card" aria-label="Join flow" style="max-width: 500px; width: 100%;">
      <div class="card-head">
        <div class="stepper" aria-label="Steps">
          <div class="chip active" id="chipStep1">1. Login</div>
          <div class="chip" id="chipStep2">2. OTP</div>
          <div class="chip" id="chipStep3">3. Details</div>
        </div>
        <div class="title" id="cardTitle">Enter your email or mobile number</div>
        <div class="subtitle" id="cardSubtitle">We will send you a One Time Password (OTP) for verification.</div>
      </div>

      <div class="card-body">
        <!-- Step 1 -->
        <div id="step1">
          <form class="form" id="formStep1">
            <div class="field">
              <label for="identifier">Email or Mobile</label>
              <input id="identifier" name="identifier" placeholder="Enter email or 10-digit mobile" autocomplete="username" required />
              <div class="hint">Example: name@gmail.com or 9876543210</div>
            </div>

            <div class="terms-checkbox">
              <input type="checkbox" id="termsAccepted" required />
              <label for="termsAccepted">
                I agree to the <a href="#" onclick="alert('Terms and conditions would open here')">Terms of Service</a> and <a href="#" onclick="alert('Privacy policy would open here')">Privacy Policy</a>
              </label>
            </div>

            <div class="actions">
              <button class="btn btn-primary" type="submit" id="sendOtpBtn">Send OTP ‚Üí</button>
              <button class="btn btn-ghost" type="button" id="demoFill">Demo Fill</button>
            </div>

            <div class="note" id="note1"></div>
            <div class="footer-mini">By continuing, you agree to BHAROSA‚Äôs terms and privacy policy.</div>
          </form>
        </div>

        <!-- Step 2 -->
        <div id="step2" class="hidden">
          <form class="form" id="formStep2">
            <div class="field">
              <label for="otp">Enter OTP</label>
              <div class="otp-row">
                <input id="otp" name="otp" inputmode="numeric" placeholder="6-digit OTP" maxlength="6" autocomplete="one-time-code" required />
                <button class="btn btn-ghost" type="button" id="resendOtp" disabled>Resend</button>
              </div>
              <div class="hint" id="sentTo">OTP sent.</div>
              <div class="otp-timer" id="otpTimer"></div>
            </div>

            <div class="actions">
              <button class="btn btn-primary" type="submit">Verify OTP ‚Üí</button>
              <button class="btn btn-ghost" type="button" id="backToStep1">‚Üê Change email/mobile</button>
            </div>

            <div class="note" id="note2"></div>
          </form>
        </div>

        <!-- Step 3 -->
        <div id="step3" class="hidden">
          <form class="form" id="formStep3">
            <div class="actions">
              <button class="btn btn-primary loc-btn" type="button" id="useLocation">Use my current location</button>
            </div>

            <div class="details-grid">
              <div class="field">
                <label for="fullName">Name</label>
                <input id="fullName" name="fullName" placeholder="Name" autocomplete="name" required />
              </div>
              <div class="field">
                <label for="mobile">10-digit mobile number</label>
                <input id="mobile" name="mobile" inputmode="numeric" placeholder="10-digit mobile number" maxlength="10" autocomplete="tel" required />
              </div>

              <div class="field">
                <label for="pincode">Pincode</label>
                <input id="pincode" name="pincode" inputmode="numeric" placeholder="Pincode" maxlength="6" required />
              </div>
              <div class="field">
                <label for="locality">Locality</label>
                <input id="locality" name="locality" placeholder="Locality" autocomplete="address-level3" required />
              </div>

              <div class="field span-2">
                <label for="address">Address (Area and Street)</label>
                <textarea id="address" name="address" placeholder="Address (Area and Street)" required></textarea>
              </div>

              <div class="field">
                <label for="city">City/District/Town</label>
                <input id="city" name="city" placeholder="City/District/Town" autocomplete="address-level2" required />
              </div>
              <div class="field">
                <label for="state">State</label>
                <select id="state" name="state" required>
                  <option value="" selected>--Select State--</option>
                  <option value="Bihar">Bihar</option>
                  <option value="Delhi">Delhi</option>
                  <option value="Haryana">Haryana</option>
                  <option value="Jharkhand">Jharkhand</option>
                  <option value="Karnataka">Karnataka</option>
                  <option value="Maharashtra">Maharashtra</option>
                  <option value="Uttar Pradesh">Uttar Pradesh</option>
                  <option value="West Bengal">West Bengal</option>
                </select>
              </div>

              <div class="field">
                <label for="landmark">Landmark (Optional)</label>
                <input id="landmark" name="landmark" placeholder="Landmark (Optional)" autocomplete="off" />
              </div>
              <div class="field">
                <label for="altPhone">Alternate Phone (Optional)</label>
                <input id="altPhone" name="altPhone" inputmode="numeric" placeholder="Alternate Phone (Optional)" maxlength="10" autocomplete="tel" />
              </div>
            </div>

            <div class="field" style="margin-top:6px">
              <label>Address Type</label>
              <div class="address-type" role="radiogroup" aria-label="Address Type">
                <label class="radio"><input type="radio" name="addressType" value="Home" checked /> Home</label>
                <label class="radio"><input type="radio" name="addressType" value="Work" /> Work</label>
              </div>
            </div>

            <div class="actions split">
              <button class="btn btn-primary btn-wide" type="submit">SAVE</button>
              <button class="btn btn-link" type="button" id="cancelDetails">CANCEL</button>
            </div>

            <div class="note" id="note3"></div>
            <div class="footer-mini">Real OTP is sent via email (SMTP) or logged for SMS demo. Configure SMTP env vars to receive emails.</div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <script>
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    const chip1 = document.getElementById('chipStep1');
    const chip2 = document.getElementById('chipStep2');
    const chip3 = document.getElementById('chipStep3');

    const cardTitle = document.getElementById('cardTitle');
    const cardSubtitle = document.getElementById('cardSubtitle');

    const formStep1 = document.getElementById('formStep1');
    const formStep2 = document.getElementById('formStep2');
    const formStep3 = document.getElementById('formStep3');

    const identifier = document.getElementById('identifier');
    const otpInput = document.getElementById('otp');

    const note1 = document.getElementById('note1');
    const note2 = document.getElementById('note2');
    const note3 = document.getElementById('note3');

    const sentTo = document.getElementById('sentTo');

    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const resendOtpBtn = document.getElementById('resendOtp');
    const otpTimerEl = document.getElementById('otpTimer');
    const termsAccepted = document.getElementById('termsAccepted');

    let generatedOtp = null;
    let savedIdentifier = null;
    let otpTimer = null;
    let resendTimeout = 30; // 30 seconds

    function setChips(activeStep){
      [chip1, chip2, chip3].forEach(c => { c.classList.remove('active'); });
      if (activeStep === 1) {
        chip1.classList.add('active');
      } else if (activeStep === 2) {
        chip1.classList.add('done');
        chip2.classList.add('active');
      } else {
        chip1.classList.add('done');
        chip2.classList.add('done');
        chip3.classList.add('active');
      }
    }

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    function setNote(noteEl, msg, showIt){
      if (!noteEl) return;
      noteEl.textContent = msg || '';
      noteEl.classList.toggle('show', Boolean(showIt));
    }

    function setLoading(button, loading) {
      if (loading) {
        button.classList.add('loading');
        button.disabled = true;
        button.textContent = 'Sending...';
      } else {
        button.classList.remove('loading');
        button.disabled = false;
        button.textContent = 'Send OTP ‚Üí';
      }
    }

    function validateIdentifier(value) {
      const input = document.getElementById('identifier');
      const valid = isValidMobile(value) || isValidEmail(value);
      
      if (value && !valid) {
        input.classList.add('error');
        input.classList.remove('success');
        return false;
      } else if (value && valid) {
        input.classList.remove('error');
        input.classList.add('success');
        return true;
      } else {
        input.classList.remove('error', 'success');
        return false;
      }
    }

    function startOtpTimer() {
      let timeLeft = resendTimeout;
      resendOtpBtn.disabled = true;
      
      otpTimer = setInterval(() => {
        otpTimerEl.textContent = `Resend OTP in ${timeLeft} seconds`;
        timeLeft--;
        
        if (timeLeft < 0) {
          clearInterval(otpTimer);
          otpTimerEl.textContent = '';
          resendOtpBtn.disabled = false;
          resendOtpBtn.textContent = 'Resend OTP';
        }
      }, 1000);
    }

    function saveFormProgress(step, data) {
      try {
        const progress = { step, ...data, timestamp: Date.now() };
        localStorage.setItem('bharosa_join_progress', JSON.stringify(progress));
      } catch (e) {
        // ignore storage issues
      }
    }

    function loadFormProgress() {
      try {
        const progress = JSON.parse(localStorage.getItem('bharosa_join_progress'));
        if (progress && Date.now() - progress.timestamp < 24 * 60 * 60 * 1000) { // 24 hours
          return progress;
        }
      } catch (e) {
        // ignore
      }
      return null;
    }

    function clearFormProgress() {
      localStorage.removeItem('bharosa_join_progress');
    }

    function goToStep1(){
      if (otpTimer) {
        clearInterval(otpTimer);
        otpTimer = null;
      }
      show(step1); hide(step2); hide(step3);
      setChips(1);
      cardTitle.textContent = 'Enter your email or mobile number';
      cardSubtitle.textContent = 'We will send you a One Time Password (OTP) for verification.';
      setNote(note1, '', false);
      setNote(note2, '', false);
      setNote(note3, '', false);
      identifier.focus();
      chip1.classList.remove('done');
      chip2.classList.remove('done');
      saveFormProgress(1, { identifier: identifier.value.trim() });
    }

    function generateOtp(){
      generatedOtp = String(Math.floor(100000 + Math.random() * 900000));
      return generatedOtp;
    }

    async function sendOtp(target){
      setLoading(sendOtpBtn, true);
      try {
        const res = await fetch('/api/send-otp', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ identifier: target })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to send OTP');
        setNote(note1, data.note || 'OTP sent successfully.', true);
        sentTo.textContent = 'OTP sent to ' + target;
        // Do NOT reveal the OTP in real flow
      } catch (e) {
        // Fallback: simulate OTP if server not available
        const otp = generateOtp();
        setNote(note1, 'Server offline ‚Äì simulated OTP sent.', true);
        setNote(note2, 'Demo: your OTP is ' + otp, true);
        sentTo.textContent = 'OTP sent to ' + target;
      } finally {
        setLoading(sendOtpBtn, false);
      }
    }

    function goToStep2(){
      hide(step1); show(step2); hide(step3);
      setChips(2);
      cardTitle.textContent = 'Verify OTP';
      cardSubtitle.textContent = 'Enter the OTP sent to your email/mobile to continue.';
      otpInput.value = '';
      otpInput.focus();
      startOtpTimer();
      saveFormProgress(2, { identifier: savedIdentifier });
    }

    function goToStep3(){
      hide(step1); hide(step2); show(step3);
      setChips(3);
      cardTitle.textContent = 'Add your basic details';
      cardSubtitle.textContent = 'This helps us deliver to the correct address.';
      const mobileEl = document.getElementById('mobile');
      if (mobileEl && savedIdentifier && isValidMobile(savedIdentifier)) {
        mobileEl.value = savedIdentifier;
      }
      document.getElementById('fullName').focus();
      saveFormProgress(3, { identifier: savedIdentifier });
    }

    formStep1.addEventListener('submit', (e) => {
      e.preventDefault();
      const value = normalizeIdentifier(identifier.value);

      if (!termsAccepted.checked) {
        setNote(note1, 'Please accept the terms and conditions.', true);
        return;
      }

      const valid = isValidMobile(value) || isValidEmail(value);
      if (!valid) {
        setNote(note1, 'Please enter a valid email or 10-digit mobile number.', true);
        return;
      }

      savedIdentifier = value;
      sendOtp(savedIdentifier);
      goToStep2();
    });

    formStep2.addEventListener('submit', async (e) => {
      e.preventDefault();
      const entered = (otpInput.value || '').trim();
      if (!/^\d{6}$/.test(entered)) {
        setNote(note2, 'Please enter a valid 6-digit OTP.', true);
        return;
      }

      try {
        const res = await fetch('/api/verify-otp', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ identifier: savedIdentifier, otp: entered })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Verification failed');
        if (!data.verified) throw new Error('Verification failed');
        setNote(note2, 'OTP verified successfully.', true);
        goToStep3();
      } catch (e) {
        // Fallback: compare with generated OTP if server not available
        if (entered === generatedOtp) {
          setNote(note2, 'OTP verified successfully (offline).', true);
          goToStep3();
        } else {
          setNote(note2, e.message || 'Incorrect OTP. Please try again.', true);
        }
      }
    });

    formStep3.addEventListener('submit', (e) => {
      e.preventDefault();
      const fullName = (document.getElementById('fullName').value || '').trim();
      const address = (document.getElementById('address').value || '').trim();
      const pincode = (document.getElementById('pincode').value || '').trim();
      const mobile = (document.getElementById('mobile').value || '').trim();
      const locality = (document.getElementById('locality').value || '').trim();
      const city = (document.getElementById('city').value || '').trim();
      const state = (document.getElementById('state').value || '').trim();
      const altPhone = (document.getElementById('altPhone').value || '').trim();

      if (!fullName) {
        setNote(note3, 'Please fill your name.', true);
        return;
      }
      if (!isValidMobile(mobile)) {
        setNote(note3, 'Please enter a valid 10-digit mobile number.', true);
        return;
      }
      if (!/^\d{6}$/.test(pincode)) {
        setNote(note3, 'Please enter a valid 6-digit pin code.', true);
        return;
      }
      if (!locality || !address || !city || !state) {
        setNote(note3, 'Please fill locality, address, city and state.', true);
        return;
      }
      if (altPhone && !/^\d{10}$/.test(altPhone)) {
        setNote(note3, 'Alternate phone should be 10 digits.', true);
        return;
      }

      try {
        const user = {
          name: fullName,
          contact: mobile,
          address,
          locality,
          city,
          state,
          pincode,
          identifier: savedIdentifier,
          addressType: document.querySelector('input[name="addressType"]:checked')?.value || 'Home'
        };
        localStorage.setItem('bharosa_user', JSON.stringify(user));
        clearFormProgress();
      } catch (e) {
        // ignore storage issues
      }

      setNote(note3, 'Details saved. Redirecting to payment‚Ä¶', true);
      window.setTimeout(() => {
        window.location.href = 'payment.html';
      }, 500);
    });

    resendOtpBtn.addEventListener('click', () => {
      if (!savedIdentifier || resendOtpBtn.disabled) return;
      sendOtp(savedIdentifier);
      startOtpTimer();
    });

    backToStep1Btn.addEventListener('click', () => {
      goToStep1();
    });

    backToStep2Btn.addEventListener('click', () => {
      goToStep2();
    });

    if (cancelDetailsBtn) {
      cancelDetailsBtn.addEventListener('click', () => {
        goToStep2();
      });
    }

    async function reverseGeocode(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('Reverse geocode failed');
      return res.json();
    }

    if (useLocationBtn) {
      useLocationBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
          setNote(note3, 'Geolocation is not supported in this browser.', true);
          return;
        }
        setNote(note3, 'Getting your location...', true);

        navigator.geolocation.getCurrentPosition(async (pos) => {
          try {
            const data = await reverseGeocode(pos.coords.latitude, pos.coords.longitude);
            const addr = data.address || {};

            const localityEl = document.getElementById('locality');
            const cityEl = document.getElementById('city');
            const pincodeEl = document.getElementById('pincode');
            const stateEl = document.getElementById('state');

            if (localityEl) localityEl.value = localityEl.value || (addr.suburb || addr.neighbourhood || addr.village || addr.hamlet || '');
            if (cityEl) cityEl.value = cityEl.value || (addr.city || addr.town || addr.county || addr.district || '');
            if (pincodeEl) pincodeEl.value = pincodeEl.value || (addr.postcode || '');
            if (stateEl && addr.state) {
              const option = Array.from(stateEl.options).find(o => (o.value || '').toLowerCase() === String(addr.state).toLowerCase());
              if (option) stateEl.value = option.value;
            }

            setNote(note3, 'Location filled. Please confirm your address details.', true);
          } catch (err) {
            setNote(note3, 'Could not auto-fill location. Please enter details manually.', true);
          }
        }, () => {
          setNote(note3, 'Location permission denied. Please enter details manually.', true);
        }, { enableHighAccuracy: false, timeout: 8000, maximumAge: 0 });
      });
    }

    // Real-time validation
    identifier.addEventListener('input', (e) => {
      validateIdentifier(e.target.value.trim());
      setNote(note1, '', false);
    });

    // Load saved progress
    const savedProgress = loadFormProgress();
    if (savedProgress) {
      if (savedProgress.step >= 1 && savedProgress.identifier) {
        identifier.value = savedProgress.identifier;
        validateIdentifier(savedProgress.identifier);
        savedIdentifier = savedProgress.identifier;
      }
      if (savedProgress.step >= 2) {
        goToStep2();
      }
      if (savedProgress.step >= 3) {
        // Load form data if available
        const savedUser = localStorage.getItem('bharosa_user');
        if (savedUser) {
          try {
            const user = JSON.parse(savedUser);
            document.getElementById('fullName').value = user.name || '';
            document.getElementById('mobile').value = user.contact || '';
            document.getElementById('address').value = user.address || '';
            document.getElementById('locality').value = user.locality || '';
            document.getElementById('city').value = user.city || '';
            document.getElementById('state').value = user.state || '';
            document.getElementById('pincode').value = user.pincode || '';
            if (user.addressType) {
              document.querySelector(`input[name="addressType"][value="${user.addressType}"]`).checked = true;
            }
            goToStep3();
          } catch (e) {
            // ignore
          }
        }
      }
    }

    demoFillBtn.addEventListener('click', () => {
      identifier.value = '9876543210';
      termsAccepted.checked = true;
      validateIdentifier(identifier.value);
      setNote(note1, '', false);
      identifier.focus();
    });

    // init
    goToStep1();
  </script>
</body>
</html>
